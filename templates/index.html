<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Sales Coaching Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow">
            <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
                <h1 class="text-3xl font-bold text-gray-900">AI Sales Coaching Dashboard</h1>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <!-- Call History -->
            <div class="bg-white shadow rounded-lg mb-6">
                <div class="px-4 py-5 sm:p-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">Call History</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sales Rep</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Duration</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Outcome</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="callsTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Call history will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Call Details Modal -->
            <div id="callDetails" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
                <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-6xl shadow-lg rounded-md bg-white">
                    <div class="px-4 py-5 sm:p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-900">Call Details & AI Analysis</h2>
                            <button onclick="closeCallDetails()" class="text-gray-400 hover:text-gray-500 text-2xl">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <!-- Call Info -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h3 class="text-lg font-medium text-gray-900 mb-3">Call Information</h3>
                                <div id="callInfo" class="space-y-2">
                                    <!-- Call info will be populated here -->
                                </div>
                                <div class="mt-4">
                                    <h4 class="font-medium text-gray-900 mb-2">Update Call Details</h4>
                                    <div class="space-y-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Call Type</label>
                                            <select id="callType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                                <option value="Phone Call">Phone Call</option>
                                                <option value="In-person">In-person</option>
                                                <option value="Google Meet">Google Meet</option>
                                                <option value="Microsoft Teams">Microsoft Teams</option>
                                                <option value="Zoom">Zoom</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Outcome</label>
                                            <select id="callOutcome" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                                <option value="">Select Outcome</option>
                                                <option value="Won">Won</option>
                                                <option value="Follow up required">Follow up required</option>
                                                <option value="Lost">Lost</option>
                                                <option value="Escalated">Escalated</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Notes</label>
                                            <textarea id="callNotes" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></textarea>
                                        </div>
                                        <button onclick="updateCallDetails()" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                            Update Details
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- AI Feedback Summary -->
                            <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                <h3 class="text-lg font-medium text-blue-900 mb-3">AI Feedback Summary</h3>
                                <div id="feedbackSummary" class="space-y-2">
                                    <!-- Feedback summary will be populated here -->
                                </div>
                            </div>
                        </div>

                        <!-- Conversation Transcript -->
                        <div class="mb-8">
                            <h3 class="text-xl font-semibold text-gray-900 mb-4">Conversation Transcript</h3>
                            <div id="conversation" class="bg-gray-50 p-4 rounded-lg border space-y-4 max-h-96 overflow-y-auto">
                                <!-- Conversation will be populated here -->
                            </div>
                        </div>

                        <!-- Comprehensive AI Analysis -->
                        <div>
                            <h3 class="text-xl font-semibold text-gray-900 mb-4">Comprehensive AI Analysis</h3>
                            <div id="detailedFeedback" class="space-y-6">
                                <!-- Detailed feedback will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let currentCallId = null;

        // Fetch and display call history
        async function loadCallHistory() {
            try {
                const response = await fetch('/api/calls');
                const calls = await response.json();
                const tableBody = document.getElementById('callsTableBody');
                tableBody.innerHTML = '';

                calls.forEach(call => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${new Date(call.timestamp).toLocaleString()}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${call.sales_rep_name}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${call.customer_name}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${call.call_type || 'Phone Call'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${Math.floor(call.duration / 60)}:${(call.duration % 60).toString().padStart(2, '0')}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                ${call.status}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getOutcomeColor(call.outcome)}">
                                ${call.outcome || 'Pending'}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            <button onclick="showCallDetails('${call.id}')" class="text-indigo-600 hover:text-indigo-900">
                                View Details
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading call history:', error);
            }
        }

        function getOutcomeColor(outcome) {
            switch (outcome) {
                case 'Won': return 'bg-green-100 text-green-800';
                case 'Follow up required': return 'bg-yellow-100 text-yellow-800';
                case 'Lost': return 'bg-red-100 text-red-800';
                case 'Escalated': return 'bg-purple-100 text-purple-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        // Show call details
        async function showCallDetails(callId) {
            currentCallId = callId;
            console.log('🔍 Opening call details for:', callId);
            try {
                const response = await fetch(`/api/calls/${callId}`);
                const data = await response.json();
                console.log('📊 API Response:', data);
                
                // Populate call info
                document.getElementById('callInfo').innerHTML = `
                    <p><strong>Date:</strong> ${new Date(data.call.timestamp).toLocaleString()}</p>
                    <p><strong>Sales Rep:</strong> ${data.call.sales_rep_name}</p>
                    <p><strong>Customer:</strong> ${data.call.customer_name}</p>
                    <p><strong>Call Type:</strong> ${data.call.call_type || 'Phone Call'}</p>
                    <p><strong>Duration:</strong> ${Math.floor(data.call.duration / 60)}:${(data.call.duration % 60).toString().padStart(2, '0')}</p>
                `;

                // Set form values
                document.getElementById('callType').value = data.call.call_type || 'Phone Call';
                document.getElementById('callOutcome').value = data.call.outcome || '';
                document.getElementById('callNotes').value = data.call.notes || '';

                // Populate conversation
                const conversationDiv = document.getElementById('conversation');
                conversationDiv.innerHTML = '';
                data.turns.forEach(turn => {
                    const turnDiv = document.createElement('div');
                    turnDiv.className = `p-3 rounded-lg ${turn.speaker === 'sales_rep' ? 'bg-blue-50' : 'bg-gray-100'}`;
                    turnDiv.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-semibold">${turn.speaker === 'sales_rep' ? data.call.sales_rep_name : data.call.customer_name}</p>
                                <p>${turn.text}</p>
                                <p class="text-xs text-gray-500">${formatTime(turn.start_time)} - ${formatTime(turn.end_time)}</p>
                            </div>
                            <div class="ml-4">
                                <textarea 
                                    class="text-sm border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                                    rows="2"
                                    placeholder="Add notes..."
                                    onchange="updateTurnNote('${turn.id}', this.value)"
                                >${turn.notes || ''}</textarea>
                            </div>
                        </div>
                    `;
                    conversationDiv.appendChild(turnDiv);
                });

                // Populate feedback if available
                if (data.feedback) {
                    console.log('✅ Feedback data available:', data.feedback);
                    // Enhanced feedback summary with conversation metrics
                    const metrics = data.feedback.conversation_metrics || {};
                    console.log('📈 Conversation metrics:', metrics);
                    document.getElementById('feedbackSummary').innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <p><strong>Overall Score:</strong> ${data.feedback.overall_score ? data.feedback.overall_score.toFixed(1) : 'N/A'}/100</p>
                                <p><strong>Primary Concern:</strong> ${data.feedback.customer_primary_concern || 'N/A'}</p>
                                <p><strong>Questions Asked:</strong> ${metrics.questionsAsked || 0}</p>
                                <p><strong>Talk Ratio:</strong> ${metrics.talkRatio ? metrics.talkRatio.toFixed(2) : 'N/A'} (Sales Rep:Customer)</p>
                            </div>
                            <div>
                                <p><strong>Sales Rep Talk Time:</strong> ${metrics.salesRepTalkTime ? metrics.salesRepTalkTime.toFixed(1) : 'N/A'}s</p>
                                <p><strong>Customer Talk Time:</strong> ${metrics.customerTalkTime ? metrics.customerTalkTime.toFixed(1) : 'N/A'}s</p>
                                <p><strong>Sales Rep Turns:</strong> ${metrics.salesRepTurns || 0}</p>
                                <p><strong>Customer Turns:</strong> ${metrics.customerTurns || 0}</p>
                            </div>
                        </div>
                    `;

                    console.log('🎯 Populating detailed feedback...');
                    // Enhanced detailed feedback with all components
                    document.getElementById('detailedFeedback').innerHTML = `
                        <!-- Full Transcript -->
                        <div class="mb-6">
                            <h4 class="font-semibold text-blue-600 mb-3">Full Transcript</h4>
                            <div class="bg-white p-4 rounded border">
                                <p class="text-gray-700 whitespace-pre-line">${data.call.transcription || 'No transcript available'}</p>
                            </div>
                        </div>

                        <!-- What Went Well -->
                        <div class="mb-6">
                            <h4 class="font-semibold text-green-600 mb-3">What Went Well</h4>
                            <div class="bg-green-50 p-4 rounded border border-green-200">
                                <p class="text-gray-700 mb-2">${data.feedback.what_went_well || 'No assessment available'}</p>
                                ${getTranscriptReferences(data.feedback.transcript_references, 'what_went_well')}
                            </div>
                        </div>

                        <!-- Areas for Improvement -->
                        <div class="mb-6">
                            <h4 class="font-semibold text-red-600 mb-3">Areas for Improvement</h4>
                            <div class="bg-red-50 p-4 rounded border border-red-200">
                                <p class="text-gray-700 mb-2">${data.feedback.what_could_be_improved || 'No assessment available'}</p>
                                ${getTranscriptReferences(data.feedback.transcript_references, 'what_could_be_improved')}
                            </div>
                        </div>

                        <!-- Discovery Questions Assessment -->
                        <div class="mb-6">
                            <h4 class="font-semibold text-purple-600 mb-3">Discovery Questions Assessment</h4>
                            <div class="bg-purple-50 p-4 rounded border border-purple-200">
                                <p class="text-gray-700 mb-2">${data.feedback.discovery_questions_assessment || 'No assessment available'}</p>
                                ${getTranscriptReferences(data.feedback.transcript_references, 'discovery_questions')}
                            </div>
                        </div>

                        <!-- Objection Handling Evaluation -->
                        <div class="mb-6">
                            <h4 class="font-semibold text-orange-600 mb-3">Objection Handling Evaluation</h4>
                            <div class="bg-orange-50 p-4 rounded border border-orange-200">
                                <p class="text-gray-700 mb-2">${data.feedback.objection_handling_evaluation || 'No evaluation available'}</p>
                                ${getTranscriptReferences(data.feedback.transcript_references, 'objection_handling')}
                            </div>
                        </div>

                        <!-- Customer's Primary Concern -->
                        <div class="mb-6">
                            <h4 class="font-semibold text-indigo-600 mb-3">Customer's Primary Concern</h4>
                            <div class="bg-indigo-50 p-4 rounded border border-indigo-200">
                                <p class="text-gray-700">${data.feedback.customer_primary_concern || 'No primary concern identified'}</p>
                            </div>
                        </div>

                        <!-- Conversation Metrics -->
                        <div class="mb-6">
                            <h4 class="font-semibold text-teal-600 mb-3">Conversation Metrics</h4>
                            <div class="bg-teal-50 p-4 rounded border border-teal-200">
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div class="text-center">
                                        <div class="text-2xl font-bold text-teal-600">${metrics.questionsAsked || 0}</div>
                                        <div class="text-sm text-gray-600">Questions Asked</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-2xl font-bold text-teal-600">${metrics.talkRatio ? metrics.talkRatio.toFixed(1) : 'N/A'}</div>
                                        <div class="text-sm text-gray-600">Talk Ratio</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-2xl font-bold text-teal-600">${metrics.salesRepTurns || 0}</div>
                                        <div class="text-sm text-gray-600">Rep Turns</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-2xl font-bold text-teal-600">${metrics.customerTurns || 0}</div>
                                        <div class="text-sm text-gray-600">Customer Turns</div>
                                    </div>
                                </div>
                                <div class="mt-4 grid grid-cols-2 gap-4">
                                    <div class="text-center">
                                        <div class="text-lg font-semibold text-teal-600">${metrics.salesRepTalkTime ? metrics.salesRepTalkTime.toFixed(1) : 'N/A'}s</div>
                                        <div class="text-sm text-gray-600">Sales Rep Talk Time</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-lg font-semibold text-teal-600">${metrics.customerTalkTime ? metrics.customerTalkTime.toFixed(1) : 'N/A'}s</div>
                                        <div class="text-sm text-gray-600">Customer Talk Time</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Recommendations -->
                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-700 mb-3">Recommendations</h4>
                            <div class="bg-gray-50 p-4 rounded border">
                                <ul class="space-y-2">
                                    ${data.feedback.recommendations ? data.feedback.recommendations.map((rec, index) => 
                                        `<li class="flex items-start">
                                            <span class="flex-shrink-0 w-6 h-6 bg-blue-100 text-blue-600 rounded-full text-sm font-medium flex items-center justify-center mr-3">${index + 1}</span>
                                            <span class="text-gray-700">${rec}</span>
                                        </li>`
                                    ).join('') : '<li class="text-gray-500">No recommendations available</li>'}
                                </ul>
                            </div>
                        </div>
                    `;
                    console.log('✅ Detailed feedback populated successfully');
                } else {
                    console.log('❌ No feedback data available');
                    document.getElementById('feedbackSummary').innerHTML = '<p class="text-gray-500">No feedback available</p>';
                    document.getElementById('detailedFeedback').innerHTML = '<p class="text-gray-500">No feedback available</p>';
                }

                console.log('🎭 Showing modal...');
                // Show the details section
                document.getElementById('callDetails').classList.remove('hidden');
                console.log('✅ Modal should be visible now');
            } catch (error) {
                console.error('❌ Error loading call details:', error);
            }
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        function getTranscriptReferences(transcriptRefs, category) {
            if (!transcriptRefs || !transcriptRefs[category] || !Array.isArray(transcriptRefs[category])) {
                return '';
            }
            
            const references = transcriptRefs[category];
            if (references.length === 0) {
                return '';
            }
            
            const refHtml = references.map(ref => {
                // Parse the reference string (format: "timestamp: X, speaker: Y, text: 'Z'")
                const match = ref.match(/timestamp: ([\d.]+), speaker: ([^,]+), text: '([^']+)'/);
                if (match) {
                    const [, timestamp, speaker, text] = match;
                    return `<div class="text-xs text-gray-600 bg-gray-50 p-2 mt-1 rounded">
                        <strong>${speaker}</strong> (${formatTime(parseFloat(timestamp))}): "${text}"
                    </div>`;
                }
                return `<div class="text-xs text-gray-600 bg-gray-50 p-2 mt-1 rounded">${ref}</div>`;
            }).join('');
            
            return `<div class="mt-2">
                <span class="text-xs font-medium text-gray-700">Transcript References:</span>
                ${refHtml}
            </div>`;
        }

        // Update call details
        async function updateCallDetails() {
            if (!currentCallId) return;

            try {
                console.log('Updating call details for:', currentCallId);
                const callType = document.getElementById('callType').value;
                const outcome = document.getElementById('callOutcome').value;
                const notes = document.getElementById('callNotes').value;
                
                console.log('Updating with:', { call_type: callType, outcome, notes });

                const response = await fetch(`/api/calls/${currentCallId}/update`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        call_type: callType,
                        outcome: outcome,
                        notes: notes,
                    }),
                });

                if (response.ok) {
                    console.log('✅ Call details updated successfully');
                    
                    // Update the call info display immediately
                    const callInfoDiv = document.getElementById('callInfo');
                    const currentInfo = callInfoDiv.innerHTML;
                    // Update the displayed call type in the modal
                    callInfoDiv.innerHTML = currentInfo.replace(
                        /<p><strong>Call Type:<\/strong>.*?<\/p>/,
                        `<p><strong>Call Type:</strong> ${callType}</p>`
                    );
                    
                    // Reload call history to show updated data with a small delay to ensure DB update
                    setTimeout(() => {
                        loadCallHistory();
                    }, 500);
                    
                    // Show success message with call type info
                    alert(`Call details updated successfully!\nCall Type: ${callType}\nOutcome: ${outcome || 'Not set'}`);
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to update call details');
                }
            } catch (error) {
                console.error('Error updating call details:', error);
                alert(`Failed to update call details: ${error.message}`);
            }
        }

        // Update conversation turn note
        async function updateTurnNote(turnId, note) {
            if (!currentCallId) return;

            try {
                const response = await fetch(`/api/calls/${currentCallId}/update`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        conversation_notes: {
                            [turnId]: note
                        }
                    }),
                });

                if (!response.ok) {
                    throw new Error('Failed to update note');
                }
            } catch (error) {
                console.error('Error updating note:', error);
                alert('Failed to update note');
            }
        }

        // Close call details
        function closeCallDetails() {
            document.getElementById('callDetails').classList.add('hidden');
            currentCallId = null;
        }

        // Load call history when page loads
        document.addEventListener('DOMContentLoaded', loadCallHistory);
    </script>
</body>
</html> 